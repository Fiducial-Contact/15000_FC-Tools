#!/bin/bash

# Step 0: ä¸€é”®æ‰§è¡Œæ‰€æœ‰æ­¥éª¤
# è¿™ä¸ªè„šæœ¬ä¼šæŒ‰é¡ºåºæ‰§è¡Œæ‰€æœ‰è®¾ç½®æ­¥éª¤

set -e

echo "========================================="
echo "Wan2.2 5B ä¸€é”®éƒ¨ç½²è„šæœ¬"
echo "========================================="
echo ""
echo "è¿™ä¸ªè„šæœ¬å°†æŒ‰é¡ºåºæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š"
echo "  1. è®¾ç½®ç¯å¢ƒå’Œå®‰è£…ä¾èµ–"
echo "  2. åˆ›å»ºé¡¹ç›®ç»“æ„"
echo "  3. ä¸‹è½½æ¨¡å‹æ–‡ä»¶ï¼ˆçº¦15GBï¼‰"
echo "  4. å‡†å¤‡è®­ç»ƒè„šæœ¬"
echo ""
echo "é¢„è®¡æ€»è€—æ—¶ï¼š40-70åˆ†é’Ÿ"
echo ""
read -p "æ˜¯å¦ç»§ç»­ï¼Ÿ(Y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Nn]$ ]]; then
    echo "å·²å–æ¶ˆ"
    exit 1
fi

# è·å–è„šæœ¬ç›®å½•
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# æ£€æŸ¥æ‰€æœ‰æ­¥éª¤è„šæœ¬æ˜¯å¦å­˜åœ¨
scripts=(
    "step1_setup_environment.sh"
    "step2_create_structure.sh"
    "step3_download_models.sh"
    "step4_prepare_training.sh"
)

for script in "${scripts[@]}"; do
    if [ ! -f "$script" ]; then
        echo "é”™è¯¯: æ‰¾ä¸åˆ°è„šæœ¬ $script"
        echo "è¯·ç¡®ä¿æ‰€æœ‰è„šæœ¬éƒ½åœ¨å½“å‰ç›®å½•"
        exit 1
    fi
done

# ç»™æ‰€æœ‰è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
echo "è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™..."
chmod +x step*.sh

# æ‰§è¡Œæ­¥éª¤ 1
echo ""
echo "========================================="
echo "æ‰§è¡Œ Step 1: è®¾ç½®ç¯å¢ƒ..."
echo "========================================="
./step1_setup_environment.sh
if [ $? -ne 0 ]; then
    echo "Step 1 å¤±è´¥ï¼"
    exit 1
fi

# æ‰§è¡Œæ­¥éª¤ 2
echo ""
echo "========================================="
echo "æ‰§è¡Œ Step 2: åˆ›å»ºé¡¹ç›®ç»“æ„..."
echo "========================================="
./step2_create_structure.sh
if [ $? -ne 0 ]; then
    echo "Step 2 å¤±è´¥ï¼"
    exit 1
fi

# æ‰§è¡Œæ­¥éª¤ 3
echo ""
echo "========================================="
echo "æ‰§è¡Œ Step 3: ä¸‹è½½æ¨¡å‹..."
echo "========================================="
echo "æç¤º: è¿™ä¸€æ­¥éœ€è¦ä¸‹è½½çº¦15GBçš„æ¨¡å‹æ–‡ä»¶ï¼Œè¯·è€å¿ƒç­‰å¾…"
./step3_download_models.sh
if [ $? -ne 0 ]; then
    echo "Step 3 å¤±è´¥ï¼"
    echo "æç¤º: å¯ä»¥é‡æ–°è¿è¡Œ ./step3_download_models.sh ç»§ç»­ä¸‹è½½"
    exit 1
fi

# æ‰§è¡Œæ­¥éª¤ 4
echo ""
echo "========================================="
echo "æ‰§è¡Œ Step 4: å‡†å¤‡è®­ç»ƒè„šæœ¬..."
echo "========================================="
./step4_prepare_training.sh
if [ $? -ne 0 ]; then
    echo "Step 4 å¤±è´¥ï¼"
    exit 1
fi

# å®Œæˆ
echo ""
echo "========================================="
echo "ğŸ‰ æ­å–œï¼æ‰€æœ‰æ­¥éª¤æ‰§è¡ŒæˆåŠŸï¼"
echo "========================================="
echo ""
echo "æ¥ä¸‹æ¥ï¼š"
echo ""
echo "1. å‡†å¤‡è®­ç»ƒæ•°æ®ï¼š"
echo "   - å°†è§†é¢‘æ–‡ä»¶æ”¾å…¥: datasets/videos/"
echo "   - å°†å›¾ç‰‡æ–‡ä»¶æ”¾å…¥: datasets/images/"
echo "   - æ¯ä¸ªæ–‡ä»¶éœ€è¦å¯¹åº”çš„ .txt æè¿°æ–‡ä»¶"
echo ""
echo "2. å¼€å§‹è®­ç»ƒï¼š"
echo "   ./step5_start_training.sh"
echo ""
echo "3. æŸ¥çœ‹å¸®åŠ©ï¼š"
echo "   cat README_QUICK_START.md"
echo ""
echo "========================================="